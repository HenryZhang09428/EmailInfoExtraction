# 项目研究问题清单

本文档列出项目中目前存在的未解决问题、技术挑战和未来研究方向。

---

## 一、数据校验与质量评估

### 1.1 模型置信度缺失（未实现）

**问题描述**：
- 当前 LLM 输出结果时**未显式提供置信度分数**
- 无法量化每个字段/单元格的提取/映射可靠性
- 仅能通过 `constraint_pass_rate` 间接评估，但无法区分「高置信度但格式错误」vs「低置信度但格式正确」

**影响**：
- 难以自动判断哪些结果需要人工审核
- 无法做置信度加权评估
- 无法在 UI 中高亮低置信度字段

**研究方向**：
- 在 prompt 中要求 LLM 输出置信度（0-1 分数）
- 或通过后处理（如多次采样、一致性检查）估算置信度
- 参考：`docs/Readme.md` 第 208 行："可后续在 prompt 或后处理中补充"

---

### 1.2 单元格一致性检查缺失（未实现）

**问题描述**：
- 同一字段在不同源文件中提取的值可能不一致
- 当前系统**未实现跨源一致性检查**
- 无法自动发现并标注冲突值

**影响**：
- 多源数据冲突时，系统无法自动识别
- 用户需要手动对比不同源的提取结果

**研究方向**：
- 在 `IntermediateRepresentation` 层面增加一致性检查
- 对同一 `Fact` 的多个 `sources` 进行值比较
- 标记冲突并生成 `warnings` 或 `conflicts` 列表
- 参考：`docs/Readme.md` 第 248 行："后续可加置信度、一致性"

---

### 1.3 模板填充路径的校验缺失

**问题描述**：
- **Attribute Set 映射路径**有完整的 `validator.validate()` 校验
- **模板填充路径**（Fill Template）**不参与** `validator` / `update_ir_scores` / groundtruth 对比
- 填充后的 Excel 文件无法自动评估质量

**影响**：
- 模板填充结果无法量化评估
- 无法与 groundtruth 对比
- 无法生成 `auto_issues.md` 和 `correction_suggestions.md`

**研究方向**：
- 为模板填充路径设计独立的校验机制
- 或扩展 `validator` 支持 `TemplateSchema` 约束
- 将填充结果转换为可校验格式（如 JSON），再走现有校验流程

---

## 二、模板解析与约束提取

### 2.1 数据校验规则解析不完整

**问题描述**：
- `parse_template_xlsx()` 中 `validations` 字段**当前为空列表**
- Excel 的数据验证规则（如下拉列表、数值范围、日期范围等）**无法被解析**
- 代码注释："当前解析能取到则填入，取不到可为空"（`docs/Readme.md` 第 140 行）

**影响**：
- 无法利用 Excel 内置的数据校验规则
- LLM 填充时可能写入不符合校验的值
- 用户需要手动在 Excel 中检查

**研究方向**：
- 使用 `openpyxl` 的 `data_validations` API 解析校验规则
- 将校验规则转换为 `Constraints.validations` 结构化数据
- 在 `TEMPLATE_FILL_PROMPT` 中指导 LLM 遵守这些规则

---

### 2.2 区域识别策略的边界情况

**问题描述**：
- 无 Excel Table 时，基于 `used_range` 自动检测表头行
- 策略：找「连续非空单元格最多」的行，且下方至少有一行非空
- **可能误判**：
  - 表格底部有备注行，被误认为表头
  - 多表格并排时，只识别第一个
  - 表头跨越多行（>2 行）时，只识别前 2 行

**影响**：
- 复杂模板可能解析失败或解析不完整
- 需要用户手动调整模板结构

**研究方向**：
- 改进表头检测算法（如考虑合并单元格、样式等）
- 支持多区域识别（一个 sheet 多个表格）
- 提供用户手动标注区域的功能

---

## 三、LLM 映射与语义理解

### 3.1 语义匹配的边界问题

**问题描述**：
- 系统通过 LLM 进行语义匹配（如「减员 ≈ 离职 ≈ 退场」）
- **可能的问题**：
  - **过度过滤**：语义等价但关键词不完全匹配时被排除
  - **过滤不足**：明显相反的数据（如「增员」填入「减员」表）仍被填入
  - 语义等价列表是硬编码的，无法适应新领域

**影响**：
- 用户反馈："我extracted出来了很多离职员工但却并未填写在我的减员表模版里"
- 需要不断调整 prompt 中的语义等价规则

**研究方向**：
- 使用更细粒度的语义相似度模型（如 embedding + 阈值）
- 让 LLM 动态生成语义等价列表，而非硬编码
- 引入「业务规则库」，支持用户自定义等价关系

---

### 3.2 Fallback 机制的局限性

**问题描述**：
- 当 LLM 生成的 FillPlan 为空时，自动使用 `build_fallback_fill_plan()`
- Fallback 使用**简单的字段名模糊匹配**（包含、部分匹配）
- **局限性**：
  - 匹配精度低，可能误匹配
  - 不支持复杂的字段映射（如「姓名」→「参保人/姓名」）
  - 无法处理多行表头的语义理解

**影响**：
- LLM 失败时，fallback 结果质量较差
- 用户需要手动修正

**研究方向**：
- 改进 fallback 的匹配算法（如使用编辑距离、语义相似度）
- 引入「映射规则库」，记录历史成功的映射关系
- 提供「半自动模式」：LLM 失败时，让用户确认 fallback 的映射关系

---

### 3.3 上下文分析的稳定性

**问题描述**：
- `_extract_template_context()` 和 `_extract_filename_context()` 使用 LLM 分析业务上下文
- **可能的问题**：
  - LLM 分析结果不稳定（同一输入可能得到不同结果）
  - 分析失败时仅打印 warning，不影响主流程，但可能降低映射质量
  - 上下文分析增加了 LLM 调用次数和成本

**影响**：
- 上下文分析失败时，映射质量可能下降
- 增加了 API 调用成本

**研究方向**：
- 缓存上下文分析结果（基于文件名/模板内容的 hash）
- 提供「上下文分析开关」，允许用户禁用以节省成本
- 使用更轻量的方法（如关键词匹配）作为 fallback

---

## 四、多源数据融合

### 4.1 数据冲突处理策略缺失

**问题描述**：
- 多个源文件可能包含同一实体的不同信息
- 当前系统在 `fill_template()` 中使用简单的**合并策略**：`merged` 字典，后写入覆盖先写入
- **未实现**：
  - 冲突检测（同一字段多个值）
  - 冲突解决策略（取最新、取最完整、取最高置信度等）
  - 冲突标注（在 FillPlan 的 `warnings` 中记录）

**影响**：
- 多源数据冲突时，用户无法知道哪些值被覆盖了
- 无法选择冲突解决策略

**研究方向**：
- 在 `IntermediateRepresentation` 层面记录冲突
- 提供多种冲突解决策略（用户可配置）
- 在 FillPlan 中标注冲突字段

---

### 4.2 数据溯源不完整

**问题描述**：
- `IntermediateRepresentation` 中的 `Fact` 记录了 `sources`，但**模板填充时未利用**
- 填充后的 Excel 无法知道每个单元格的值来自哪个源文件
- 无法追踪「为什么这个值被填入」

**影响**：
- 调试困难：无法追溯填充值的来源
- 无法做「源文件级别的质量评估」

**研究方向**：
- 在 FillPlan 中记录每个值的 `source_id`
- 在填充后的 Excel 中添加「来源」列或批注
- 提供「溯源视图」：点击单元格查看来源

---

## 五、错误处理与鲁棒性

### 5.1 编码错误的静默处理

**问题描述**：
- 多处使用 `errors='ignore'` 处理编码错误（如 `email_extractor.py`、`text_extractor.py`）
- **可能的问题**：
  - 编码错误被静默忽略，导致文本丢失
  - 用户无法知道哪些内容因编码问题未被提取

**影响**：
- 提取结果可能不完整
- 难以排查编码问题

**研究方向**：
- 记录编码错误到 `warnings`
- 尝试多种编码（如 `chardet` 库自动检测）
- 在 UI 中显示编码警告

---

### 5.2 文件路径匹配的脆弱性

**问题描述**：
- `run_extract()` 使用 `file_path_map = {Path(fp).name: fp}` 匹配文件
- **可能的问题**：
  - 同名文件会被覆盖（只保留最后一个路径）
  - 如果 `source_doc.filename` 与实际上传的文件名不一致，匹配失败

**影响**：
- 同名文件上传时可能处理错误
- 文件名规范化不一致时匹配失败

**研究方向**：
- 使用更健壮的匹配策略（如文件 hash、上传顺序）
- 在 `SourceDoc` 中记录原始路径，而非仅文件名
- 提供文件名冲突检测和解决机制

---

## 六、性能与可扩展性

### 6.1 LLM 调用成本优化

**问题描述**：
- 每个文件提取、上下文分析、填充计划生成都需要 LLM 调用
- **成本问题**：
  - 多文件、大文件时调用次数多
  - 上下文分析增加了额外调用
  - 无缓存机制，重复处理相同文件会重复调用

**研究方向**：
- 实现结果缓存（基于文件 hash）
- 批量处理优化（合并多个文件的 prompt）
- 提供「快速模式」：禁用上下文分析，使用更便宜的模型

---

### 6.2 大文件处理性能

**问题描述**：
- 大 Excel 文件（如数万行）解析和填充可能较慢
- 图片文件较大时，VLM 调用可能超时
- 当前无分块处理机制

**研究方向**：
- Excel 分块读取和填充
- 图片压缩或分块处理
- 异步处理大文件，提供进度条

---

## 七、用户体验与可操作性

### 7.1 错误信息的可读性

**问题描述**：
- 错误信息多为技术性（如 traceback），用户难以理解
- 缺少「用户友好的错误提示」和「建议操作」

**研究方向**：
- 错误分类和友好提示
- 提供「常见问题解答」和「故障排除指南」
- 在 UI 中显示错误原因和建议操作

---

### 7.2 结果可视化不足

**问题描述**：
- 当前 UI 主要展示 JSON 和表格
- **缺少**：
  - 填充前后的对比视图
  - 字段映射关系的可视化
  - 冲突/警告的高亮显示

**研究方向**：
- 添加「映射关系图」：显示源字段 → 模板列的映射
- 添加「差异对比视图」：填充前后对比
- 在表格中高亮冲突/警告单元格

---

## 总结

以上研究问题按优先级可分类为：

1. **高优先级**（影响核心功能）：
   - 1.3 模板填充路径的校验缺失
   - 3.1 语义匹配的边界问题
   - 4.1 数据冲突处理策略缺失

2. **中优先级**（影响用户体验）：
   - 1.1 模型置信度缺失
   - 2.1 数据校验规则解析不完整
   - 5.1 编码错误的静默处理

3. **低优先级**（优化和扩展）：
   - 1.2 单元格一致性检查
   - 6.1 LLM 调用成本优化
   - 7.2 结果可视化不足

---

**最后更新**：2024年（基于当前代码库分析）
